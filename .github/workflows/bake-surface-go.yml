name: Bake surface-go
'on':
  workflow_run:
    workflows:
      - Bake amd64
    types:
      - completed
  workflow_dispatch:
    inputs:
      no-push:
        description: Do not push to DockerHub
        required: false
        type: boolean
        default: false
      cancel-in-progress:
        description: Cancel all in-progress bake workflows and only run this one
        required: false
        type: boolean
        default: false
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: ${{ inputs.cancel-in-progress == true }}
jobs:
  prepare-surface-go-alpine:
    name: Prepare surface-go-alpine
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || (github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure') }}
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-alpine.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-alpine:
    name: Bake surface-go-alpine
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-alpine
    env:
      LIBRARY: library/surface-go-alpine.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-alpine.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-debian:
    name: Prepare surface-go-debian
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || (github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure') }}
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-debian.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-debian:
    name: Bake surface-go-debian
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-debian
    env:
      LIBRARY: library/surface-go-debian.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-debian.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-fedora:
    name: Prepare surface-go-fedora
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || (github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure') }}
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-fedora.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-fedora:
    name: Bake surface-go-fedora
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-fedora
    env:
      LIBRARY: library/surface-go-fedora.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-fedora.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-ubuntu:
    name: Prepare surface-go-ubuntu
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || (github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure') }}
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-ubuntu.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-ubuntu:
    name: Bake surface-go-ubuntu
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-ubuntu
    env:
      LIBRARY: library/surface-go-ubuntu.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-ubuntu.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-alpine-golang:
    name: Prepare surface-go-alpine-golang
    runs-on: ubuntu-latest
    needs: bake-surface-go-alpine
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-alpine-golang.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-alpine-golang:
    name: Bake surface-go-alpine-golang
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-alpine-golang
    env:
      LIBRARY: library/surface-go-alpine-golang.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-alpine-golang.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-alpine-node:
    name: Prepare surface-go-alpine-node
    runs-on: ubuntu-latest
    needs: bake-surface-go-alpine
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-alpine-node.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-alpine-node:
    name: Bake surface-go-alpine-node
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-alpine-node
    env:
      LIBRARY: library/surface-go-alpine-node.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-alpine-node.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-alpine-python:
    name: Prepare surface-go-alpine-python
    runs-on: ubuntu-latest
    needs: bake-surface-go-alpine
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-alpine-python.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-alpine-python:
    name: Bake surface-go-alpine-python
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-alpine-python
    env:
      LIBRARY: library/surface-go-alpine-python.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-alpine-python.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-debian-dotnet:
    name: Prepare surface-go-debian-dotnet
    runs-on: ubuntu-latest
    needs: bake-surface-go-debian
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-debian-dotnet.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-debian-dotnet:
    name: Bake surface-go-debian-dotnet
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-debian-dotnet
    env:
      LIBRARY: library/surface-go-debian-dotnet.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-debian-dotnet.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-debian-golang:
    name: Prepare surface-go-debian-golang
    runs-on: ubuntu-latest
    needs: bake-surface-go-debian
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-debian-golang.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-debian-golang:
    name: Bake surface-go-debian-golang
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-debian-golang
    env:
      LIBRARY: library/surface-go-debian-golang.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-debian-golang.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-debian-node:
    name: Prepare surface-go-debian-node
    runs-on: ubuntu-latest
    needs: bake-surface-go-debian
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-debian-node.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-debian-node:
    name: Bake surface-go-debian-node
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-debian-node
    env:
      LIBRARY: library/surface-go-debian-node.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-debian-node.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-debian-openjdk:
    name: Prepare surface-go-debian-openjdk
    runs-on: ubuntu-latest
    needs: bake-surface-go-debian
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-debian-openjdk.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-debian-openjdk:
    name: Bake surface-go-debian-openjdk
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-debian-openjdk
    env:
      LIBRARY: library/surface-go-debian-openjdk.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-debian-openjdk.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-debian-python:
    name: Prepare surface-go-debian-python
    runs-on: ubuntu-latest
    needs: bake-surface-go-debian
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-debian-python.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-debian-python:
    name: Bake surface-go-debian-python
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-debian-python
    env:
      LIBRARY: library/surface-go-debian-python.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-debian-python.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-fedora-golang:
    name: Prepare surface-go-fedora-golang
    runs-on: ubuntu-latest
    needs: bake-surface-go-fedora
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-fedora-golang.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-fedora-golang:
    name: Bake surface-go-fedora-golang
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-fedora-golang
    env:
      LIBRARY: library/surface-go-fedora-golang.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-fedora-golang.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-fedora-node:
    name: Prepare surface-go-fedora-node
    runs-on: ubuntu-latest
    needs: bake-surface-go-fedora
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-fedora-node.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-fedora-node:
    name: Bake surface-go-fedora-node
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-fedora-node
    env:
      LIBRARY: library/surface-go-fedora-node.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-fedora-node.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-fedora-python:
    name: Prepare surface-go-fedora-python
    runs-on: ubuntu-latest
    needs: bake-surface-go-fedora
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-fedora-python.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-fedora-python:
    name: Bake surface-go-fedora-python
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-fedora-python
    env:
      LIBRARY: library/surface-go-fedora-python.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-fedora-python.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-ubuntu-dotnet:
    name: Prepare surface-go-ubuntu-dotnet
    runs-on: ubuntu-latest
    needs: bake-surface-go-ubuntu
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-ubuntu-dotnet.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-ubuntu-dotnet:
    name: Bake surface-go-ubuntu-dotnet
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-ubuntu-dotnet
    env:
      LIBRARY: library/surface-go-ubuntu-dotnet.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-ubuntu-dotnet.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-ubuntu-golang:
    name: Prepare surface-go-ubuntu-golang
    runs-on: ubuntu-latest
    needs: bake-surface-go-ubuntu
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-ubuntu-golang.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-ubuntu-golang:
    name: Bake surface-go-ubuntu-golang
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-ubuntu-golang
    env:
      LIBRARY: library/surface-go-ubuntu-golang.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-ubuntu-golang.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-ubuntu-node:
    name: Prepare surface-go-ubuntu-node
    runs-on: ubuntu-latest
    needs: bake-surface-go-ubuntu
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-ubuntu-node.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-ubuntu-node:
    name: Bake surface-go-ubuntu-node
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-ubuntu-node
    env:
      LIBRARY: library/surface-go-ubuntu-node.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-ubuntu-node.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-ubuntu-python:
    name: Prepare surface-go-ubuntu-python
    runs-on: ubuntu-latest
    needs: bake-surface-go-ubuntu
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-ubuntu-python.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-ubuntu-python:
    name: Bake surface-go-ubuntu-python
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-ubuntu-python
    env:
      LIBRARY: library/surface-go-ubuntu-python.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-ubuntu-python.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
  prepare-surface-go-ubuntu-openjdk:
    name: Prepare surface-go-ubuntu-openjdk
    runs-on: ubuntu-latest
    needs: bake-surface-go-ubuntu
    outputs:
      bake-targets: ${{ steps.bake-targets.outputs.matrix }}
    env:
      LIBRARY: library/surface-go-ubuntu-openjdk.json
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set matrix
        id: bake-targets
        run: |
          set -x
          targets="$(jq -cr '.group.default.targets' $LIBRARY)"
          echo "matrix=$targets" >> $GITHUB_OUTPUT
  bake-surface-go-ubuntu-openjdk:
    name: Bake surface-go-ubuntu-openjdk
    runs-on:
      - self-hosted
      - base-images
      - X64
    timeout-minutes: 240
    needs: prepare-surface-go-ubuntu-openjdk
    env:
      LIBRARY: library/surface-go-ubuntu-openjdk.json
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.prepare-surface-go-ubuntu-openjdk.outputs.bake-targets) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Setup buildx
        id: setup-buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb
        with:
          driver-opts: network=host
          install: true
      - name: Setup QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf
        with:
          platforms: all
          image: tonistiigi/binfmt:qemu-v8.0.4-33
        if: contains(steps.setup-buildx.outputs.platforms, 'linux/amd64') == false
      - name: Login to DockerHub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        if: inputs.no-push != true
        with:
          registry: docker.io
          username: ${{ secrets.BALENAIMAGES_USER }}
          password: ${{ secrets.BALENAIMAGES_TOKEN }}
      - name: Set the DATESTAMP variable
        run: echo "DATESTAMP=$(date +%Y%m%d)" >> "${GITHUB_ENV}"
      - name: Docker bake
        continue-on-error: false
        id: docker_bake
        uses: docker/bake-action@7a5dfed3550ca014665af2a27af8fc9d7284b9b3
        with:
          workdir: balena-base-images
          files: ${{ github.workspace }}/${{ env.LIBRARY }}
          targets: ${{ matrix.target }}
          push: ${{ inputs.no-push != true }}
          provenance: false
